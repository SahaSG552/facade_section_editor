# Инструкция по тестированию

## Документация

Полную документацию по модульной архитектуре см.:
- **[ARCHITECTURE.md](./ARCHITECTURE.md)** - Архитектура и структура модулей
- **[API_REFERENCE.md](./API_REFERENCE.md)** - Справочник API
- **[INTEGRATION_GUIDE.md](./INTEGRATION_GUIDE.md)** - Руководство интеграции
- **[CHANGELOG.md](./CHANGELOG.md)** - История изменений рефакторинга

## Тестирование модульной архитектуры

### Проверка PanelManager

#### Управление размерами панели
```
✓ Изменить ширину панели - визуально обновляется
✓ Изменить высоту панели - визуально обновляется
✓ Изменить толщину панели - влияет на отступы
✓ Проверить координаты якоря - вычисляются корректно
```

**Тестирование в консоли**:
```javascript
// Получить текущие параметры
console.log(panelManager.getWidth());
console.log(panelManager.getAnchor());

// Изменить параметры
panelManager.setWidth(300);
panelManager.setHeight(400);

// Переключить якорь
panelManager.cyclePanelAnchor();
```

#### Система якорей (top-left/bottom-left)
```
✓ Якорь по умолчанию - top-left
✓ Кнопка переключает якорь
✓ Маркер якоря обновляется немедленно
✓ Позиции фрез пересчитываются правильно
✓ Смещение якоря влияет на отступы
```

**Тестирование**:
1. Добавить фрезу при якоре top-left
2. Записать её Y координату
3. Нажать кнопку переключения якоря
4. Проверить, что координата фрезы пересчитана правильно
5. Проверить, что визуально фреза на месте

### Проверка BitsTableManager

#### Отображение таблицы
```
✓ Таблица отображает все фрезы
✓ Строки в правильном порядке
✓ Все колонки видны (X, Y, Align, Op, Color, Delete)
✓ Значения в таблице соответствуют канвасу
```

#### Редактирование координат
```
✓ Редактировать X координату
✓ Редактировать Y координату
✓ Работают математические выражения (100+50, 200*2)
✓ Некорректные выражения отклоняются
✓ Таблица и канвас синхронизируются
```

**Тестирование**:
1. Добавить фрезу
2. Кликнуть на X поле в таблице
3. Ввести "100+50"
4. Нажать Enter
5. Проверить, что фреза переместилась на X=150

#### Операции с фрезами в таблице
```
✓ Циклирование выравнивания (left → center → right)
✓ Изменение операции (AL → OU → IN → VC)
✓ Выбор цвета из палитры
✓ Удаление фрезы
✓ Перетаскивание для переупорядочивания
```

**Тестирование перетаскивания**:
1. Добавить 3 фрезы
2. Перетащить вторую фрезу на место третьей
3. Проверить, что порядок изменился
4. Проверить, что индексы обновились

### Проверка SelectionManager

#### Выделение фрез
```
✓ Кликнуть на фрезу на канвасе - выделяется
✓ Кликнуть на строку в таблице - выделяется
✓ Выделенная фреза имеет синий контур
✓ Выделенная строка подсвечена
✓ Повторный клик отменяет выделение
```

#### Множественное выделение
```
✓ Ctrl+клик добавляет к выделению
✓ Все выделенные фрезы имеют синий контур
✓ Все выделенные строки подсвечены
✓ Клик на пустое место отменяет выделение
```

**Тестирование**:
1. Добавить 3 фрезы
2. Кликнуть на первую - выделена
3. Ctrl+Клик на третью - обе выделены
4. Ctrl+Клик на первую снова - выделена только третья
5. Клик на пустое место - выделение отменено

#### Выделение и синхронизация
```
✓ Выделение сохраняется при перетаскивании
✓ Выделение обновляется при удалении
✓ Выделение отражается в обеих панелях
```

### Проверка ResizeObserver

#### Изменение размера канваса
```
✓ При переключении вида (2D ↔ 3D ↔ Both) канвас меняет размер
✓ Фантомные фрезы не смещаются при смене размера
✓ Отступы не смещаются при смене размера
```

**Тестирование**:
1. Добавить фрезу с операцией VC (будут фантомные фрезы)
2. Отметить позицию фантомных фрез визуально
3. Кликнуть кнопку переключения вида (2D/3D)
4. Проверить, что фантомные фрезы остались на месте
5. Повторить несколько раз - позиции должны быть стабильны

### Проверка связи модулей

#### Поток добавления фрезы
```
✓ Клик на фрезу в левой панели
✓ Появляется на 2D канвасе
✓ Появляется строка в таблице
✓ Обновляются отступы/фантомные фрезы
✓ Фреза имеет уникальный ID
```

#### Поток перемещения фрезы
```
✓ Перетащить фрезу на канвасе
✓ Таблица обновляет координаты
✓ Отступы обновляются
✓ Фантомные фрезы обновляются (если VC)
✓ 3D вид обновляется (если включен)
```

#### Поток изменения операции
```
✓ Изменить операцию AL → VC
✓ Появляются фантомные фрезы
✓ Появляются отступы
✓ Изменить операцию VC → AL
✓ Фантомные фрезы исчезают
✓ Отступы остаются (для AL тоже есть)
```

## Инструкция по тестированию CSG функциональности (старая)

```bash
npm install  # Установить зависимости (три-bvh-csg уже добавлен)
npm run dev  # Запустить dev сервер
```

Приложение доступно по адресу: **http://localhost:5174/**

## Шаги для тестирования

### 1. Базовая функциональность (без 3D)

1. Добавьте несколько фрез на 2D канвас:
   - Откройте левую панель "Bits" (библиотеку фрез)
   - Перетащите фрезы на 2D канвас

2. Проверьте кнопку "Bits":
   - Клик по кнопке "Bits" (иконка фреза)
   - Фрезы на 2D канвасе должны скрываться/показываться
   - Кнопка должна менять визуальное состояние (bits-visible ↔ bits-hidden)

3. Проверьте кнопку "Part":
   - Клик по кнопке "Part" (иконка материала)
   - Должен появиться пунктирный контур вычтенного материала
   - Панель должна скрываться (видна только часть)
   - Кнопка должна менять состояние (part-visible ↔ part-hidden)

### 2. 3D функциональность

1. Переключитесь в 3D вид:
   - Нажмите кнопку "3D" (или "Both" для наглядности)
   - Панель должна появиться в 3D

2. Проверьте видимость фрез в 3D:
   - Кнопка "Bits" должна скрывать/показывать 3D меши фрез
   - Работает синхронно с 2D представлением

3. Проверьте CSG операцию:
   - Нажмите кнопку "Part"
   - В 3D должен примениться CSG:
     - Вместо отдельных объектов (панель + фрезы) должен быть один меш с вычтенной геометрией
     - Панель должна выглядеть как материал с отверстиями/пазами от фрез
   - Нажмите еще раз:
     - CSG должен отменяться
     - Вернется отдельное отображение панели и фрез

### 3. Расширенное тестирование

#### 3.1 Видимость фрез + CSG
1. Активируйте "Part" (CSG включен)
2. Нажмите "Bits" (фрезы скрыты)
   - Ожидается: видна только результирующая панель (с отверстиями)
3. Нажмите "Bits" снова (фрезы показаны)
   - Ожидается: видна панель + фрезы поверх

#### 3.2 Изменение параметров панели
1. Активируйте 3D вид с CSG включенным
2. Измените размеры панели:
   - Измените Width/Height/Thickness в левой панели
   - 3D должен обновиться с новыми размерами
   - CSG операция должна переприменяться автоматически

#### 3.3 Добавление/удаление фрез
1. CSG активирован, видна результирующая панель
2. Добавьте еще фрезу:
   - Перетащите на 2D канвас
   - 3D должен обновиться
   - CSG переприменится с новой фрезой
3. Удалите фрезу:
   - Нажмите кнопку удаления в таблице
   - 3D обновится (CSG переприменится)

#### 3.4 Переключение между представлениями
1. 2D вид:
   - Активируйте "Part"
   - Видна часть материала
2. Переключитесь на 3D:
   - Должно быть видно 3D представление с CSG
3. Вернитесь на 2D:
   - Смещение контурных линий не должно быть (это была ошибка, исправлена в updateOffsetContours)

## Проверка консоли

Откройте DevTools (F12) и смотрите консоль на предмет ошибок:

### Ожидаемые логи:
```
ThreeModule: Updating panel {width: 400, height: 600, thickness: 19, bits: 2}
ThreeModule: Creating bit path extrusions 2
CSG operation applied successfully
```

### Ошибки (если есть):
- "CSG is not exported" - проблема с импортом (должна быть исправлена)
- "Error applying CSG operation" - CSG не смог выполнить операцию (fallback на отдельное отображение)

## Примеры проблем, которые могли быть

1. **Фрезы не обновляются при изменении профиля**
   - ✅ Исправлено: добавлен вызов `updateThreeView()` в `updateCanvasBitsForBitId()`

2. **Камера сбрасывается при каждом обновлении**
   - ✅ Исправлено: добавлена проверка `cameraFitted` флага

3. **Кнопки "Bits" и "Part" не влияют на 3D**
   - ✅ Исправлено: добавлены вызовы методов ThreeModule в `toggleBitsVisibility()` и `togglePartView()`

## Отладка

Если что-то не работает, проверьте:

1. **Открыта ли 3D сцена?**
   - Нужно быть в режиме "3D" или "Both"

2. **Есть ли фрезы на канвасе?**
   - Без фрез CSG ничего не будет вычитать

3. **Видны ли логи в консоли?**
   - Если нет логов "Updating panel" - updateThreeView() не вызывается

4. **Работает ли 2D часть?**
   - 3D синхронизируется с 2D, поэтому 2D должна работать корректно

## Производительность

Для больших моделей (10+ фрез) CSG операция может занимать время:
- Первое применение CSG: ~100-500ms
- Последующие обновления (если кэширование): ~10-50ms

Это нормально для CSG операций.
